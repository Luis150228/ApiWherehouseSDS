<div class="card b64viewer">
  <div class="card-header">Evidencia (imagen Base64)</div>

  <div class="card-body">
    <div class="row g-2 align-items-end">
      <div class="col-12 col-sm-4">
        <label for="folio-view" class="form-label">Folio</label>
        <input id="folio-view" type="text" class="form-control" placeholder="INC00000000">
      </div>

      <div class="col-12 col-sm-8 d-flex gap-2">
        <button id="btn-load-img" class="btn btn-primary btn-sm">Ver imagen</button>
        <button id="btn-clear-img" class="btn btn-secondary btn-sm">Limpiar</button>
        <button id="btn-download-img" class="btn btn-outline-primary btn-sm" disabled>Descargar</button>
      </div>
    </div>

    <div id="b64frame" class="b64frame mt-3">
      <div class="placeholder">Sin imagen…</div>
      <img id="b64img" alt="Evidencia" hidden loading="lazy">
      <div class="b64spinner" hidden></div>
    </div>
  </div>
</div>


/***********************CSS****************************/
.b64viewer .b64frame{
  position: relative;
  border: 1px solid #ddd;
  background: #f5f5f5;
  height: 320px;               /* ajusta alto del visor */
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: auto;
  border-radius: .5rem;
}
.b64viewer .b64frame img{
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
}
.b64viewer .b64frame .placeholder{
  color: #888;
  font-size: .95rem;
}
.b64viewer .b64frame .b64spinner{
  position: absolute;
  inset: 0;
  background: rgba(255,255,255,.6);
}
.b64viewer .b64frame .b64spinner::after{
  content: "";
  position: absolute;
  width: 36px;
  height: 36px;
  border: 3px solid #bbb;
  border-top-color: #c62828;   /* rojo */
  border-radius: 50%;
  animation: spin 0.9s linear infinite;
  top: 50%; left: 50%;
  transform: translate(-50%,-50%);
}
@keyframes spin { to { transform: translate(-50%,-50%) rotate(360deg); } }


/**********js*////////////////
<script>
// ——— util: arma data URL a partir de b64 “puro” + mime ———
function toDataUrl(b64, mime) {
  if (!b64) return '';
  // Si ya viene en formato dataURL, úsalo tal cual
  if (b64.startsWith('data:')) return b64;
  const safeMime = mime || 'image/png';
  return `data:${safeMime};base64,${b64}`;
}

// ——— util: descarga ———
function downloadBase64(b64, mime = 'image/png', filename = 'evidencia.png') {
  // Si ya es dataURL:
  const dataUrl = b64.startsWith('data:') ? b64 : toDataUrl(b64, mime);
  const a = document.createElement('a');
  a.href = dataUrl;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

// ——— cache local para habilitar “Descargar” ———
const state = { current: null }; // { b64, mime, folio }

// ——— UI refs ———
const folioEl   = document.getElementById('folio-view');
const frameEl   = document.getElementById('b64frame');
const imgEl     = document.getElementById('b64img');
const phEl      = frameEl?.querySelector('.placeholder');
const spinEl    = frameEl?.querySelector('.b64spinner');
const btnLoad   = document.getElementById('btn-load-img');
const btnClear  = document.getElementById('btn-clear-img');
const btnDown   = document.getElementById('btn-download-img');

// ——— render local ———
function renderImage(b64, mime) {
  const dataUrl = toDataUrl(b64, mime);
  if (!dataUrl) {
    imgEl.hidden = true;
    phEl.hidden = false;
    btnDown.disabled = true;
    state.current = null;
    return;
  }
  imgEl.src = dataUrl;
  imgEl.hidden = false;
  phEl.hidden = true;
  btnDown.disabled = false;
  state.current = { b64, mime, folio: (folioEl.value || '').trim() };
}

// ——— limpia visor ———
function clearImage() {
  imgEl.removeAttribute('src');
  imgEl.hidden = true;
  phEl.hidden = false;
  btnDown.disabled = true;
  state.current = null;
}

// ——— spinner helpers ———
function showSpin(on) {
  if (!spinEl) return;
  spinEl.hidden = !on;
  btnLoad.disabled = !!on;
}

// ——— ejemplo de carga desde backend ———
// Ajusta la URL y payload a tu API real.
// Esperado: { code: 200, data: { img_b64: "...", img_mime: "image/png" } }
// Si no hay imagen: code 204
async function fetchImageByFolio(folio) {
  const url = 'http://TU_BACKEND/genericos';
  const body = JSON.stringify({ typeGeneric: 'activate', order: 'GET_IMAGE', generic: folio });
  const res = await fetch(url, { method: 'POST', headers: { 'Content-Type':'application/json' }, body });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

// ——— eventos ———
btnLoad?.addEventListener('click', async () => {
  const folio = (folioEl.value || '').trim();
  if (!folio) { alert('Captura folio.'); return; }

  try {
    showSpin(true);
    const resp = await fetchImageByFolio(folio);

    if (Number(resp?.code) === 200 && resp?.data?.img_b64) {
      renderImage(resp.data.img_b64, resp.data.img_mime || 'image/png');
    } else if (Number(resp?.code) === 204) {
      clearImage();
      alert('Sin imagen para este folio.');
    } else {
      clearImage();
      alert('Respuesta inesperada del servidor.');
    }
  } catch (err) {
    console.error(err);
    clearImage();
    alert('Error de red/servidor.');
  } finally {
    showSpin(false);
  }
});

btnClear?.addEventListener('click', () => {
  folioEl.value = '';
  clearImage();
});

btnDown?.addEventListener('click', () => {
  if (!state.current) return;
  const name = `Evidencia_${state.current.folio || 'sin_folio'}.png`;
  downloadBase64(state.current.b64, state.current.mime, name);
});

// ——— si ya tienes b64/mime en cliente y solo quieres pintarlo: ———
// renderImage('<BASE64_SIN_PREFIJO>', 'image/png');
// renderImage('data:image/png;base64,iVBORw0KGgoAAA...', null);
</script>
