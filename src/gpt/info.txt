<div class="control-btn-generics">
  <div class="mb-3">
    <label class="form-label">Seguimiento a Genérico</label>

    <!-- 1) Folio -->
    <input
      class="form-control mb-2"
      type="text"
      placeholder="INC000"
      id="inc-generic"
      name="inc-generic"
      aria-label="INC000 example"
    />

    <!-- 2) Imagen -->
    <input
      class="form-control mb-2"
      type="file"
      id="inc-image"
      accept="image/*"
      aria-label="Selecciona imagen (máx. 9MB)"
    />
    <div class="form-text">JPEG/PNG/WebP, máx. 9&nbsp;MB</div>

    <!-- 3) Preview opcional -->
    <div id="img-preview" class="mt-2"></div>

    <!-- 4) Botón al fondo del card -->
    <div class="d-grid mt-3">
      <button type="button" class="btn btn-primary btn-sm" id="save-generic-active">
        Seguimiento
      </button>
    </div>
  </div>

  <div id="save-generic-msg" class="msg"></div>
</div>



/************************************************************/
ALTER TABLE eut_genericactive
  ADD COLUMN img_b64 LONGTEXT NULL,
  ADD COLUMN img_mime VARCHAR(64) NULL,
  ADD COLUMN img_size INT NULL,
  ADD COLUMN img_added_at DATETIME NULL DEFAULT CURRENT_TIMESTAMP;

/************************************************************/

// --- helpers para preview (opcional) ---
const inpGeneric = document.getElementById('inc-generic');
const inpImage   = document.getElementById('inc-image');
const btnSave    = document.getElementById('save-generic-active');
const msgBox     = document.getElementById('save-generic-msg');
const prevZone   = document.getElementById('img-preview');

// Preview
inpImage?.addEventListener('change', () => {
  if (!prevZone) return;
  prevZone.innerHTML = '';
  const f = inpImage.files?.[0];
  if (!f) return;
  const url = URL.createObjectURL(f);
  const img = document.createElement('img');
  img.src = url;
  img.alt = 'preview';
  img.style.maxWidth = '220px';
  img.style.maxHeight = '160px';
  img.style.objectFit = 'contain';
  prevZone.appendChild(img);
  // liberar URL cuando cargue
  img.onload = () => URL.revokeObjectURL(url);
});

// Tamaño máximo 9 MB (binario, no Base64)
const MAX_BYTES = 9 * 1024 * 1024;

// Convierte File -> { b64: '...', mime: 'image/png' }
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onerror = () => reject(new Error('No se pudo leer el archivo'));
    fr.onload = () => {
      const dataUrl = String(fr.result || '');
      // data:image/png;base64,AAAA...
      const m = dataUrl.match(/^data:(.+?);base64,(.*)$/);
      if (!m) return reject(new Error('Formato de imagen inválido'));
      resolve({ b64: m[2], mime: m[1] });
    };
    fr.readAsDataURL(file);
  });
}

function isValidImageType(mime) {
  return /^image\/(png|jpeg|jpg|webp|gif)$/i.test(mime);
}

// —— click guardar —— //
btnSave?.addEventListener('click', async (e) => {
  e.preventDefault();
  if (!inpGeneric) return;

  const folio = (inpGeneric.value || '').trim();
  if (!folio) {
    showMsg('Captura un folio.', 'warn');
    return;
  }

  const file = inpImage?.files?.[0] || null;

  // Validaciones de imagen si se adjunta
  let imgPayload = null;
  if (file) {
    if (file.size > MAX_BYTES) {
      showMsg('La imagen excede 9 MB.', 'err');
      return;
    }
    // revisa mime rápido antes de leer
    if (!isValidImageType(file.type)) {
      showMsg('Tipo de imagen no permitido.', 'err');
      return;
    }
    try {
      const { b64, mime } = await fileToBase64(file);
      imgPayload = { img_b64: b64, img_mime: mime, img_size: file.size };
    } catch (err) {
      console.error(err);
      showMsg('No se pudo procesar la imagen.', 'err');
      return;
    }
  }

  // bloquea UI mientras envías
  showBtnSpinner(btnSave, 'Guardando…');
  inpGeneric.setAttribute('disabled', 'true');
  inpImage?.setAttribute('disabled', 'true');

  // arma payload para tu backend
  const payload = {
    typeGeneric: 'activate',        // lo estás usando ya
    order: 'CREATE_OR_UPDATE',      // ajusta si tu backend espera otra cosa
    generic: folio,
    // solo manda imagen si hay
    ...(imgPayload ? imgPayload : {})
  };

  try {
    const res = await fetchPOST('genericos', payload);
    const code = Number(res?.code);

    if (code === 200) {
      inpGeneric.value = '';
      if (inpImage) { inpImage.value = ''; prevZone && (prevZone.innerHTML = ''); }
      showMsg('Guardado correctamente.', 'ok');
      // refresca lista si viene en respuesta
      if (res?.data) liActiveGeneric(res.data, 'list-active-generic');
    } else if (code === 204) {
      showMsg('El folio no existe (204).', 'err');
    } else if (code === 413) {
      showMsg('Payload demasiado grande (413).', 'err');
    } else {
      showMsg(`Error inesperado${code ? ` (${code})` : ''}.`, 'err');
    }
  } catch (err) {
    console.error(err);
    showMsg('Error de red/servidor.', 'err');
  } finally {
    hideBtnSpinner(btnSave);
    inpGeneric.removeAttribute('disabled');
    inpImage?.removeAttribute('disabled');
  }
});

/* ====== Si NO tienes estas utilidades, déjalas aquí ====== */
function showBtnSpinner(btn, text = 'Procesando…') {
  if (!btn) return;
  if (btn.dataset.busy === '1') return;
  btn.dataset.busy = '1';
  btn.disabled = true;
  if (!btn.dataset.prevHtml) btn.dataset.prevHtml = btn.innerHTML;
  btn.innerHTML = `<span class="mini-spinner" aria-hidden="true"></span> ${text}`;
}
function hideBtnSpinner(btn) {
  if (!btn) return;
  btn.disabled = false;
  btn.innerHTML = btn.dataset.prevHtml || 'Guardar';
  btn.dataset.busy = '0';
  delete btn.dataset.prevHtml;
}
function showMsg(text, kind = 'ok') {
  const box = msgBox || null;
  if (!box) { alert(text); return; }
  box.textContent = text;
  box.className = `msg ${kind}`;
  clearTimeout(showMsg.tid);
  showMsg.tid = setTimeout(() => { box.textContent = ''; box.className = 'msg'; }, 3000);
}

