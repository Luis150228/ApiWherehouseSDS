<table class="table-analyst table align-middle">
  <thead>
    <tr>
      <th scope="col">Expediente</th>
      <th scope="col">Nombre</th>
      <th scope="col"></th>
    </tr>
  </thead>
  <tbody id="analyst-tbody" class="table-group-divider"></tbody>
</table>

<!-- Barra de controles: paginación + buscador -->
<div class="d-flex justify-content-between align-items-center gap-2 flex-wrap">
  <nav aria-label="Paginación analistas">
    <ul id="analyst-pagination" class="pagination mb-0"></ul>
  </nav>

  <div class="input-group" style="max-width: 320px;">
    <span class="input-group-text"><i class="bi bi-search"></i></span>
    <input id="analyst-search" type="search" class="form-control" placeholder="Buscar por expediente o nombre">
    <button id="analyst-clear" class="btn btn-outline-secondary" type="button">Limpiar</button>
  </div>
</div>

<script>
  // ----- Config y estado -----
const PAGE_SIZE = 5;
let currentPage = 1;
let baseData = data;               // <- tu arreglo "data" del mensaje
let filteredData = [...baseData];  // estado actual filtrado

// ----- DOM -----
const tbody = document.getElementById('analyst-tbody');
const pager = document.getElementById('analyst-pagination');
const searchInput = document.getElementById('analyst-search');
const clearBtn = document.getElementById('analyst-clear');

// ===== 1) FUNCIÓN: crear tabla =====
function buildAnalystTableRows(items, tbodyEl) {
  if (!tbodyEl) return;
  if (!items.length) {
    tbodyEl.innerHTML = `
      <tr>
        <td colspan="3" class="text-center text-muted py-4">Sin resultados</td>
      </tr>`;
    return;
  }

  const rowsHtml = items.map((r, idx) => `
    <tr>
      <th scope="row">${r.analyst_expediente || '-'}</th>
      <td>${r.analyst_name || '-'}</td>
      <td class="text-end">
        <div class="btn-group" role="group" aria-label="Acciones analista ${r.analyst_expediente || ''}">
          <button type="button" class="btn btn-info" data-action="config" data-exp="${r.analyst_expediente}">
            <i class="bi bi-person-fill-gear"></i>
          </button>
          <button type="button" class="btn btn-danger" data-action="remove" data-exp="${r.analyst_expediente}">
            <i class="bi bi-person-dash-fill"></i>
          </button>
        </div>
      </td>
    </tr>
  `).join('');

  tbodyEl.innerHTML = rowsHtml;
}

// ===== 2) FUNCIÓN: filtrar (por expediente o nombre) =====
function applyAnalystFilter(dataArr, query) {
  const q = (query ?? '').trim().toLowerCase();
  if (!q) return [...dataArr];

  return dataArr.filter(r => {
    const exp = (r.analyst_expediente || '').toLowerCase();
    const name = (r.analyst_name || '').toLowerCase();
    return exp.includes(q) || name.includes(q);
  });
}

// ===== 3) FUNCIÓN: paginación (máx 5 botones: « p p p ») =====
function buildPagination(totalItems, current, pageSize, ulEl) {
  if (!ulEl) return;
  const totalPages = Math.max(1, Math.ceil(totalItems / pageSize));
  const makeItem = (label, page, disabled = false, active = false, aria = '') => `
    <li class="page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}">
      <a class="page-link" href="#" data-page="${page}" ${aria}>${label}</a>
    </li>`;

  // Cálculo de ventana de 3 páginas visibles
  let start = 1, end = Math.min(3, totalPages);
  if (totalPages > 3) {
    if (current <= 1) { start = 1; end = 3; }
    else if (current >= totalPages) { start = totalPages - 2; end = totalPages; }
    else { start = current - 1; end = current + 1; }
  }

  let html = '';
  // Prev «
  html += makeItem('&laquo;', Math.max(1, current - 1), current === 1, false, 'aria-label="Anterior"');

  // Páginas numéricas
  for (let p = start; p <= end; p++) {
    html += makeItem(String(p), p, false, p === current, `aria-label="Página ${p}"`);
  }

  // Next »
  html += makeItem('&raquo;', Math.min(totalPages, current + 1), current === totalPages, false, 'aria-label="Siguiente"');

  ulEl.innerHTML = html;
}

// ===== Glue: actualizar vista =====
function updateView() {
  const total = filteredData.length;
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));

  // Seguridad por si el filtro deja pocas páginas
  if (currentPage > totalPages) currentPage = totalPages;

  const start = (currentPage - 1) * PAGE_SIZE;
  const slice = filteredData.slice(start, start + PAGE_SIZE);

  buildAnalystTableRows(slice, tbody);
  buildPagination(total, currentPage, PAGE_SIZE, pager);
}

// ===== Eventos =====

// Click paginación (delegación)
pager.addEventListener('click', (e) => {
  const a = e.target.closest('a.page-link');
  if (!a) return;
  e.preventDefault();

  const pageAttr = a.getAttribute('data-page');
  if (!pageAttr) return;

  const totalPages = Math.max(1, Math.ceil(filteredData.length / PAGE_SIZE));
  const candidate = Number(pageAttr);

  if (isNaN(candidate)) return;
  currentPage = Math.min(Math.max(1, candidate), totalPages);
  updateView();
});

// Buscador (con debounce ligero)
let t;
searchInput.addEventListener('input', () => {
  clearTimeout(t);
  t = setTimeout(() => {
    filteredData = applyAnalystFilter(baseData, searchInput.value);
    currentPage = 1;
    updateView();
  }, 200);
});

// Botón limpiar
clearBtn.addEventListener('click', () => {
  searchInput.value = '';
  filteredData = [...baseData];
  currentPage = 1;
  updateView();
});

// Acciones de fila (config/remove) - ejemplo de delegación en la tabla
tbody.addEventListener('click', (e) => {
  const btn = e.target.closest('button[data-action]');
  if (!btn) return;
  const action = btn.dataset.action;
  const expediente = btn.dataset.exp;

  if (action === 'config') {
    // TODO: abre modal/config del analista
    console.log('Configurar', expediente);
  } else if (action === 'remove') {
    // TODO: acción de baja
    console.log('Eliminar', expediente);
  }
});

// Inicializa
updateView();

</script>
