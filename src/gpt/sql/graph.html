mainScore.js:54 Uncaught (in promise) ReferenceError: Cannot access 'toBarDataTable' before initialization
    at drawChart (mainScore.js:54:18)
drawChart	@	mainScore.js:54
Promise.then		
Cc	@	loader.js:143
(anónimas)	@	mainScore.js:8


import { byId } from './js/utils/dom.js';
import { fetchGet } from '../../../js/connect.js';
import { divLoader } from '../../../js/elements.js';

byId('reportWrap')?.setAttribute('data-set', true)
divLoader();
google.charts.load('current', { packages: ['bar'] });
google.charts.setOnLoadCallback(drawChart);
// Se solicita la data
const apiResponse = await fetchGet('genericos', { generics: true, score: true, xlsx: 'noGenerate' })

// Normaliza nombre de analista
const normalizeAnalyst = (v) => {
    const s = (v ?? '').toString().trim();
    return s.length ? s : 'Sin analista';
};

// --- Función independiente: JSON -> DataTable (agrupado por analyst_name)
const toBarDataTable = (json) => {
    const rows = Array.isArray(json?.data) ? json.data : [];

    // Agrupar por analyst_name
    const grouped = new Map();
    for (const r of rows) {
        const key = normalizeAnalyst(r.analyst_name);
        if (!grouped.has(key)) {
            grouped.set(key, { total: 0, valid: 0, invalid: 0 });
        }
        const g = grouped.get(key);
        g.total += Number(r.total_fields) || 0;
        g.valid += Number(r.valid_count) || 0;
        g.invalid += Number(r.invalid_count) || 0;
    }

    // Construir DataTable
    const dt = new google.visualization.DataTable();
    dt.addColumn('string', 'Analyst');  // categoría
    dt.addColumn('number', 'Sales');    // total_fields
    dt.addColumn('number', 'Expenses'); // valid_count
    dt.addColumn('number', 'Profit');   // invalid_count

    // Pasar filas ordenadas por Sales (desc)
    const dataRows = [...grouped.entries()]
        .sort((a, b) => b[1].total - a[1].total)
        .map(([name, v]) => [name, v.total, v.valid, v.invalid]);

    dt.addRows(dataRows);
    return dt;
};

function drawChart() {
    // Si en prod lo traes por fetch:
    // const json = await (await fetch('/tu/endpoint')).json();
    // const data = toBarDataTable(json);
    const data = toBarDataTable(apiResponse);

    const options = {
        chart: {
            title: 'Calidad por analista',
            subtitle: 'Sales=total_fields, Expenses=valid_count, Profit=invalid_count'
        }
    };

    const chart = new google.charts.Bar(
        document.getElementById('columnchart_material')
    );
    chart.draw(data, google.charts.Bar.convertOptions(options));
}
