ELSE
    INSERT INTO tmp_tabla_plantillas
    SELECT 
        r.folio,
        IF(r.incidencia_secundarias >= 1, r.folio, r.incidencia_principal) AS incidencia_padre,
        IFNULL(w.usuario, 'SIN DATOS') AS expediente,
        r.abierto_por,
        r.nombreproyecto,
        'SIN DATOS' AS ext_contacto,
        IFNULL(l.num_movil, 'SIN DATOS') AS cel_contacto,
        w.supervisor AS nombre2_contacto,
        'SIN DATOS' AS cel2_contacto,
        w.mail,
        w.puesto,
        RIGHT(w.cc_wd, 4) AS cc,
        REGEXP_REPLACE(w.region, '^Region[[:space:]]+', '') AS region,
        w.upn_wd AS UPN,
        w.n_user AS usuario_n,
        IFNULL(c.ip_address, 'SIN DATOS') AS IP,
        IFNULL(c.name, 'SIN DATOS') AS hostname,
        r.suc_corp AS tipo_usuario,
        'SIN DATOS' AS descripcion_incidente,
        'SIN DATOS' AS numero_afectados,
        'SIN DATOS' AS carrier,
        'SIN DATOS' AS IP_carrier,
        r.origen
    FROM eut_reportesbk.servicenow_reportes r
    LEFT JOIN eut_toolmovil.eut_workday w 
        ON r.abierto_por = w.nombre_full
    LEFT JOIN eut_toolmovil.inventario_lineas l 
        ON w.usuario = l.expediente
    LEFT JOIN (
        SELECT cm1.*
        FROM eut_reportesbk.eut_cmdb cm1
        INNER JOIN (
            SELECT expediente, MAX(u_created_date) AS max_date
            FROM eut_reportesbk.eut_cmdb
            GROUP BY expediente
        ) cm2 ON cm1.expediente = cm2.expediente 
             AND cm1.u_created_date = cm2.max_date
    ) c ON w.usuario = c.expediente
    WHERE (r.incidencia_principal != '' OR r.incidencia_secundarias >= 1)
      AND r.origen = 'SNGlobal Incidentes'
      AND r.abierto >= '2025-07-01 00:00:00';
END IF;


CREATE INDEX idx_cmdb_expediente_fecha 
ON eut_cmdb (expediente, u_created_date DESC);

CREATE INDEX idx_origen_fecha 
ON servicenow_reportes (origen, abierto);

CREATE INDEX idx_workday_nombre_usuario 
ON eut_workday (nombre_full, usuario);
