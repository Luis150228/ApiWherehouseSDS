DELIMITER $$

CREATE FUNCTION fn_extract_phone_from_celular(texto LONGTEXT)
RETURNS VARCHAR(20)
DETERMINISTIC
BEGIN
    DECLARE resultado VARCHAR(20);

    -- Extrae desde "Celular" hasta el salto de línea
    SET resultado = REGEXP_SUBSTR(
        texto,
        '(?i)Celular[:? ]*[0-9()+ -]+'
    );

    -- Limpia palabra "Celular" y caracteres no numéricos
    IF resultado IS NOT NULL THEN
        SET resultado = REGEXP_REPLACE(resultado, '(?i)Celular[:? ]*', '');
        SET resultado = REGEXP_REPLACE(resultado, '[^0-9]', '');
    END IF;

    -- Si después de limpiar no queda nada, devolver 'SIN_DATOS'
    RETURN IF(resultado IS NULL OR resultado = '', 'SIN_DATOS', resultado);
END$$

DELIMITER ;
